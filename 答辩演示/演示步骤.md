# 演示步骤

## 裸机

- 克隆仓库，切换到`mxy-dev`分支
```sh
git clone https://github.com/muxinyu1/virtio-drivers.git
cd virtio-drivers/
git checkout mxy-dev
```
- 进入裸机演示文件夹
```sh
cd examples/riscv
```
- 编译运行裸机驱动程序
```sh
make qemu
```

> - 确保qemu版本有对`virtio sound device`的支持（如qemu-9.0.0），可以查阅对应版本的文档确认
>
> - `examples/riscv`下的`makefile`依赖于`ASLA`，确保Linux已经安装了`ALSA`

### 演示内容

- 正确识别virtio sound设备
- 打印virtio sound设备的streams，jacks，chmaps信息
- 用输出流播放音乐（裸机）

### 演示代码

```rust
fn virtio_sound<T: Transport>(transport: T) {
    // 初始化virtio sound驱动程序
    let mut sound =
        VirtIOSound::<HalImpl, T>::new(transport).expect("failed to create sound driver");
    // 每个virtio sound设备可能有很多流（streams），播放音乐需要获取输出流，qemu目前有一个输出流和一个输入流
    let output_streams = sound.output_streams();
    if output_streams.len() > 0 {
        // 获取第一个输出流（qemu目前只有一个输出流）
        let output_stream_id = *output_streams.first().unwrap();
        // 获取输出流支持的采样率
        let rates = sound.rates_supported(output_stream_id).unwrap();
        // 获取输出流支持的采样深度
        let formats = sound.formats_supported(output_stream_id).unwrap();
        // 获取输出流支持的通道数（耳机听歌就是立体声stereo，双声道）
        let channel_range = sound.channel_range_supported(output_stream_id).unwrap();
        // 目前qemu不支持features，因此这里features是0
        let features = sound.features_supported(output_stream_id).unwrap();

        let rate = if rates.contains(PcmRate::VIRTIO_SND_PCM_RATE_44100) {
            PcmRate::VIRTIO_SND_PCM_RATE_44100
        } else {
            PcmRate::VIRTIO_SND_PCM_RATE_32000
        };
        let format = if formats.contains(PcmFormats::VIRTIO_SND_PCM_FMT_U8) {
            // 用8bit表示采样点的声音信息
            PcmFormats::VIRTIO_SND_PCM_FMT_U8
        } else {
            PcmFormats::VIRTIO_SND_PCM_FMT_U32
        };
        // qemu支持立体声，所以声道数为2
        let channel = if channel_range.contains(&2) {
            2 as u8
        } else {
            *channel_range.start()
        };
        // 为某个stream设置参数，包括采样率，采样深度等
        sound
            .pcm_set_params(
                output_stream_id,
                441 * 2, // buffer_size
                441, // period_size，每播放完441字节的pcm帧，都会触发中断，在virtio中表现为设备给驱动的notification，但是目前qemu的virtio sound不支持VIRTIO_SND_PCM_F_EVT_SHMEM_PERIODS，我们也就无法收到来自设备的通知，因此只能用双缓冲区
                features,
                channel,
                format,
                rate,
            )
            .expect("pcm_set_params error");
        // PCM的生命周期：prepare-start
        sound
            .pcm_prepare(output_stream_id)
            .expect("pcm_prepare error");
        sound.pcm_start(output_stream_id).expect("pcm_start error");
        // 音频样本的采样率是441000Hz，采样深度是8bit，立体声
        let music = include_bytes!("../Nocturne_44100Hz_u8_stereo.raw");
        info!("[sound device] music len is {} bytes.", music.len());
        // 用同步的方式播放音频，当播放完才返回
        sound.pcm_xfer(output_stream_id, &music[..]).expect("pcm_xfer error");
        sound.pcm_stop(output_stream_id).expect("pcm_stop error");
        sound.pcm_release(output_stream_id).expect("pcm_release error");
    }
}
```

## Alien

克隆仓库，切换分支：

```sh
git clone https://github.com/muxinyu1/Alien.git
cd Alien
git checkout mxy-dev
```

运行：

```sh
sudo make run SOUND=y
```