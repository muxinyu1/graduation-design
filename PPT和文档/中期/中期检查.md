# 中期检查

## 主要研究内容

- 异步编程：Rust语言提供了一种高效的异步编程模型，使用`async/await`语法和`Future` trait实现异步操作。主要研究内容包括使用Rust的异步编程模型来设计和管理音频驱动的异步任务，包括音频数据的读取、处理和输出等。
- 跨平台适配：Rust具有良好的跨平台支持，在不同操作系统上进行开发和运行。主要研究内容包括分析和适配不同操作系统的音频驱动接口，使用Rust的平台相关特性和库来实现对应的功能，以确保模块在各个平台上的兼容性和稳定性。
- 性能优化：使用Rust语言进行音频驱动模块的性能优化。这包括使用Rust的高性能数据结构和算法来提高音频数据的处理速度，减少延迟，优化内存管理和资源占用等。
- 异常处理与错误恢复：使用Rust语言设计健壮的异常处理机制和错误恢复策略。这利用Rust的错误处理机制（例如Result和Option）来处理异常情况，并使用panic和recover机制来进行错误恢复，以保证音频驱动模块的稳定性和可靠性。

### 异步编程

Rust提供了一种强大且高效的异步编程模型，基于`async/await`语法和`Future` trait。异步编程允许程序在等待I/O、计算或其他操作完成时，能够继续执行其他任务，而不会阻塞线程。

异步编程在Rust中的基本概念如下：

1. `async`和`await`：`async`关键字用于定义异步函数或方法，而`await`关键字用于等待异步操作的完成。通过使用`async`和`await`，在代码中以同步的方式编写异步操作，使得异步代码更加易读和可维护。
2. `Future` trait：`Future` trait代表一个异步操作的未来结果。异步函数或方法返回的类型通常是实现了`Future` trait的类型。`Future` trait提供了一系列方法，例如`map`、`and_then`等，用于对异步操作的结果进行转换和组合。
3. `async/await`代码块：使用`async`关键字将一段代码块标记为异步块，其中使用`await`关键字等待其他异步操作的完成。异步块在需要时被调用和执行，以便异步操作能够以非阻塞的方式进行。
4. `tokio`和`async-std`：这是两个常用的异步运行时库，提供了异步任务的调度和执行环境。它们提供了一系列的工具和功能，例如任务调度器、定时器、异步IO等，简化异步编程的实现和管理。

#### `Embassy`异步运行时

Embassy是一个基于Rust语言的嵌入式系统异步运行时。它旨在提供高效、可靠和易用的异步编程模型，适用于嵌入式系统和其他资源受限的环境。

Embassy的特点和设计思想如下：

1. 轻量级：Embassy致力于在嵌入式环境中提供轻量级的异步运行时。它采用最小化的代码依赖和运行时开销，以满足资源受限的嵌入式系统的要求。
2. 高性能：Embassy通过使用非阻塞的异步编程模型，以及针对嵌入式系统的优化，提供了高性能的异步操作。它有效地利用硬件资源，提供快速的响应和高效的并发处理。
3. 低延迟：Embassy专注于降低异步操作的延迟。它提供了基于事件驱动的异步调度器，在没有线程切换和阻塞的情况下处理多个异步任务，从而减少了延迟。
4. 内存安全：Embassy遵循Rust语言的内存安全和线程安全原则，通过所有权和借用系统预防了数据竞争和内存错误。这使得Embassy在嵌入式系统中能够提供更高的可靠性和安全性。
5. 设备驱动支持：Embassy提供了用于编写设备驱动程序的接口和工具。它支持异步IO、定时器、中断处理等嵌入式系统常见的功能，帮助开发者更方便地编写异步驱动程序。

## 进展情况及取得的成果

### 串口

串口（Serial Port）是一种用于数据传输的通信接口，它是计算机与外部设备之间进行数据交换的一种常见方式。串口通过串行传输数据，将数据位逐位地发送和接收。串口通常用于连接各种外部设备，例如调制解调器、打印机、传感器、嵌入式系统等。

串口的特点包括：

1. 串行传输：串口通过逐位地传输数据，将每个数据位依次发送或接收。与并行传输相比，串行传输只需要少量的线路，更适合长距离通信。
2. 异步通信：在异步串口通信中，数据的传输是按照逐个字节的方式进行的，每个字节之间没有固定的时间间隔。为了确保数据的正确性，通常使用启动位、数据位、校验位和停止位等来实现帧同步和错误检测。
3. 波特率：串口通信中的波特率（Baud Rate）表示每秒传输的位数。波特率越高，传输速度越快，但也要求更高的信号质量和更可靠的电路设计。
4. 通信协议：串口通信使用不同的通信协议，如RS-232、RS-485、UART等。这些协议定义了物理电气特性、数据帧格式、数据流控制等规范，以确保通信的正确性和可靠性。

在计算机中，通过串口连接外部设备需要使用串口控制器和相应的驱动程序。串口驱动程序负责与串口控制器进行交互，控制数据的发送和接收。

对于串口驱动程序，目前的进展是已经从`rCore-N`中提取出异步串口驱动程序，并能正确地在原`rCore-N`中引用，通过测试用例。

### H.264

H.264，全称为Advanced Video Coding (AVC) 或 MPEG-4 Part 10，是一种广泛使用的视频压缩标准。它是由国际标准化组织（ISO）和国际电信联盟（ITU）共同制定的，于2003年发布。H.264在视频压缩方面取得了显著的进展，为数字视频传输、存储和广播提供了高效的解决方案。

H.264的主要特点包括：

1. 高压缩率：H.264采用了一系列先进的压缩技术，如运动补偿、帧内预测、帧间预测和变换编码等。这些技术极大地减少视频数据的存储空间和传输带宽需求，同时保持较高的视觉质量。
2. 高质量视频：尽管H.264实现了高压缩率，但它仍能提供出色的视频质量。相比于早期的压缩标准，如MPEG-2，H.264能够以更低的比特率传输相同质量的视频。
3. 广泛支持：H.264已经成为一种广泛支持的视频编解码标准，几乎在所有数字视频设备和平台上都找到。它被广泛应用于视频会议、流媒体、移动通信、数字电视和互联网视频等领域。
4. 灵活性：H.264支持多种分辨率和帧率的视频，适应不同的应用需求。它还支持多种编码配置选项，允许根据具体应用场景进行参数调整。
5. 实时性：H.264在实时应用中使用，例如视频会议和实时流媒体。它提供了低延迟的编码和解码选项，以满足实时传输的需求。

H.264的应用场景非常广泛，包括互联网视频（如YouTube、Netflix）、数字电视广播、视频会议系统、监控摄像头、移动通信（如3G、4G和5G视频通话）等领域。它的高压缩率和高质量使得H.264成为当前最常用的视频压缩标准之一。

对于H.264硬件解码器的异步程序的开发，目前已经确定开发步骤，如下：

1. 确定硬件规格：仔细查阅星光2（VisionFive2）的文档，了解其硬件规格、处理器架构、内存布局和外设接口等详细信息。特别关注与H.264硬件解码器相关的部分，包括解码器的接口、寄存器和功能等。
2. 确定开发环境：选择适合的开发环境和工具链来开发裸机驱动程序。星光2（VisionFive2）开发板通常支持多种开发环境，例如Keil MDK、IAR Embedded Workbench、GCC等。选择`Visual Studio Code`作为开发的IDE。
3. 初始化硬件：编写初始化代码，配置星光2（VisionFive2）开发板上的H.264硬件解码器。这涉及对解码器寄存器进行初始化、设置输入输出接口、配置解码器的工作模式等。
4. 编写解码器驱动程序：根据星光2（VisionFive2）的文档和H.264硬件解码器的规格，编写解码器的驱动程序。这包括实现解码器的控制函数、数据传输函数和状态管理等。
5. 集成解码器驱动程序：将解码器驱动程序集成到裸机应用程序中。编写应用程序的主循环，调用解码器驱动程序的函数来启动解码过程、传输数据和获取解码结果。
6. 测试和调试：编译和烧录裸机应用程序到星光2（VisionFive2）开发板上，进行测试和调试。确保解码器驱动程序能够正确地初始化硬件、接收输入数据、进行解码操作并输出解码结果。
7. 优化和性能调整：根据实际需求和性能要求，进行优化和性能调整。这包括调整解码器的参数、优化数据传输方式、改进内存管理等，以提高解码器的效率和性能。

## 存在的问题和解决方案

#### 异步串口的效率不高

解决方案为将串口驱动程序与Embassy异步运行时结合，步骤如下：

1. 在项目的Cargo.toml文件中，添加`embassy-executor` crate作为依赖项：
   ```toml
   [dependencies]
   embassy-executor = "0.5.0"
   ```

2. 运行Cargo命令，下载并构建`embassy-executor` crate：
   ```bash
   $ cargo build
   ```

3. 在异步串口驱动程序中，导入`embassy`和`embassy_executor`模块：
   ```rust
   use embassy::executor::Spawner;
   use embassy_executor::Executor;
   ```

4. 初始化Embassy执行器：
   ```rust
   #[embassy::main]
   async fn main() {
       let executor = Executor::new();
       executor.run().unwrap();
   }
   ```

5. 在异步串口驱动程序中，使用`embassy_executor::Spawner` trait来启动异步任务。例如，使用`embassy_executor::Spawner`的`spawn`方法来启动异步写入任务：
   ```rust
   async fn send_data(serial: &mut MySerial, data: &[u8]) {
       // 异步写入数据
   }
   
   #[embassy::task]
   async fn send_task(serial: &mut MySerial, data: &[u8]) {
       send_data(serial, data).await;
   }
   
   fn main() {
       // ...
       embassy_executor::Spawner::spawn(send_task(serial, data));
       // ...
   }
   ```

6. 构建和测试：使用Cargo构建项目，并进行测试和调试，以确保Embassy异步运行时框架已正确集成到异步串口驱动程序中。

这些步骤将`embassy-executor` crate集成到项目中，并使用Embassy异步运行时框架来管理异步任务。

### 对H.264解码器驱动程序开发认识不充分

解决方案如下：

1. **理解H.264解码器原理**: H.264是一种视频压缩标准，了解其原理和工作方式对于开发解码器驱动程序至关重要。通过阅读H.264标准文档、专业书籍或在线教程来深入了解。
2. **研究星光2开发板**: 星光2开发板可能具有特定的硬件架构和驱动程序要求。查阅相关的开发文档、用户手册或论坛帖子，了解该开发板的技术规格和支持情况。
3. **阅读示例代码和文档**: 在网上搜索H.264解码器的Rust实现或与星光2开发板兼容的驱动程序示例代码。

## 下一步的任务

1. 改进异步串口驱动程序的效率，加入Embassy运行时
2. 学习裸机驱动程序开发步骤，尝试编写H.264解码器驱动程序的原型
